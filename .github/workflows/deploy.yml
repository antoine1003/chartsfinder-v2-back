name: Deploy to VPS

on:
    push:
        branches:
            - main

jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
            -   name: Checkout code
                uses: actions/checkout@v4

            -   name: Set up SSH
                run: |
                    mkdir -p ~/.ssh
                    echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
                    chmod 600 ~/.ssh/id_rsa
                    ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

            -   name: Rsync files to VPS with correct user
                run: |
                    rsync -avz --delete \
                      --exclude=".git*" \
                      --exclude="node_modules" \
                      --exclude="vendor" \
                      --exclude="var/cache" \
                      --exclude="var/log" \
                      --chown=adautry:www-data \
                      ./ \
                      ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/var/www/cf-v2/back

            -   name: Run remote deployment commands
                run: |
                    ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
                    set -euo pipefail
                    cd /var/www/cf-v2/back
                     # S'assurer que les droits restent propres apr√®s le rsync
                    find . -type d -exec chmod 2775 {} \;
                    find . -type f -exec chmod 664 {} \;

                    # Var doit √™tre √©crivable par www-data (au cas o√π)
                    setfacl -R -m u:www-data:rwx var || true
                    setfacl -dR -m u:www-data:rwx var || true

                    export APP_ENV=prod APP_DEBUG=0
                    export COMPOSER_NO_INTERACTION=1
                    umask 002

                    # üîπ Ajouter ou mettre √† jour la cl√© API dans .env.local
                    touch .env.local
                    if grep -q "^MAILER_DSN=" .env.local; then
                        sed -i "s|^MAILER_DSN=.*|MAILER_DSN=${{ secrets.BREVO_API_KEY }}|" .env.local
                    else
                        echo "MAILER_DSN=brevo+api://${{ secrets.BREVO_API_KEY }}@default" >> .env.local
                    fi
                    echo "‚úÖ Cl√© API mise √† jour dans .env.local"

                    # Install vendors (plugins enabled for Flex)
                     sudo -u www-data composer install --prefer-dist --no-dev --optimize-autoloader

                    # Generate compiled env (optional if you already rely on server vars)
                     sudo -u www-data composer dump-env prod

                    # Clear & warmup cache in prod
                     sudo -u www-data php bin/console cache:clear --env=prod --no-warmup
                     sudo -u www-data php bin/console d:s:u -f
                     sudo -u www-data php bin/console cache:warmup --env=prod

                    # R√©attribuer tout le dossier √† www-data
                    sudo chown -R www-data:www-data /var/www/cf-v2/back
                    echo "‚úÖ Droits r√©attribu√©s √† www-data"

                    echo "‚úÖ D√©ploiement termin√© sur le serveur"
                    EOF
